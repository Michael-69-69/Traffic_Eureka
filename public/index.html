<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Traffic App</title>
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            overflow: auto;
            color: #333;
        }
        #map-container {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        #map {
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        #map-error, #map-loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        #map-error {
            color: #d32f2f;
            font-size: 16px;
            font-weight: 500;
        }
        #map-loading {
            color: #2e7d32;
            font-size: 16px;
            font-weight: 500;
        }
        #search-form {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 300px;
            height: 40px;
            display: flex;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            z-index: 10;
            transition: box-shadow 0.3s ease;
        }
        #search-form:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        #search-bar {
            flex: 1;
            padding: 0 15px;
            font-size: 14px;
            border: none;
            outline: none;
            background: transparent;
        }
        #search-button {
            width: 40px;
            background: #2e7d32;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        #search-button:hover {
            background: #1b5e20;
        }
        #other-functions {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            font-size: 14px;
            background: #ffffff;
            color: #2e7d32;
            border: 1px solid #2e7d32;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
            transition: all 0.3s ease;
        }
        #other-functions:hover {
            background: #2e7d32;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        #view-live-feeds {
            position: absolute;
            top: 70px;
            right: 20px;
            padding: 10px 20px;
            font-size: 14px;
            background: #ffffff;
            color: #2e7d32;
            border: 1px solid #2e7d32;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
            transition: all 0.3s ease;
        }
        #view-live-feeds:hover {
            background: #2e7d32;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        #toggle-options {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 14px;
            background: #ffffff;
            color: #2e7d32;
            border: 1px solid #2e7d32;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
            transition: all 0.3s ease;
        }
        #toggle-options:hover {
            background: #2e7d32;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        #options-panel, #traffic-panel {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            width: 600px;
            min-width: 400px;
            max-width: 90vw;
            padding: 15px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
            cursor: move;
            max-height: 80vh;
            overflow-y: auto;
            resize: both;
            overflow: auto;
        }
        #options-panel .close-btn, #traffic-panel .close-btn {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            line-height: 20px;
            text-align: center;
            transition: background 0.3s ease;
            z-index: 11;
        }
        #options-panel .close-btn:hover, #traffic-panel .close-btn:hover {
            background: #b71c1c;
        }
        #controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        #weather-icon {
            width: 30px;
            height: 30px;
            background: url('https://openweathermap.org/img/wn/10d@2x.png') no-repeat center;
            background-size: contain;
            margin-right: 10px;
        }
        select {
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            transition: border-color 0.3s ease;
        }
        select:focus {
            border-color: #2e7d32;
            outline: none;
        }
        #live-camera {
            width: 100%;
            height: 400px;
            border: 2px solid #2e7d32;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: #000;
            margin-bottom: 15px;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            z-index: 10;
        }
        #camera-select {
            margin: 10px;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            width: calc(100% - 20px);
            max-width: 500px;
        }
        #camera-video {
            width: 100%;
            height: calc(100% - 80px);
            background: #000;
        }
        #camera-status {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 12;
        }
        #camera-data {
            display: none;
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
        }
        #graph-container {
            width: 100%;
            height: 150px;
            border: 2px solid #d32f2f;
            background: #fff;
            border-radius: 4px;
            position: relative;
            overflow: hidden;
            z-index: 10;
        }
        #graph-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }
        #function-menu {
            display: none;
            position: absolute;
            top: 60px;
            right: 20px;
            width: 200px;
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
            padding: 5px 0;
        }
        #function-menu button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background 0.3s ease;
        }
        #function-menu button:hover {
            background: #f5f7fa;
        }
        #hazard-form, #incident-form {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            z-index: 20;
            width: 300px;
        }
        #hazard-form label, #incident-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2e7d32;
        }
        #hazard-form input, #incident-form input, #hazard-form input[type="file"], #incident-form input[type="file"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        #hazard-form button, #incident-form button {
            padding: 10px 20px;
            background: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
            margin-right: 10px;
        }
        #hazard-form button:hover, #incident-form button:hover {
            background: #1b5e20;
        }
        #cancel-hazard, #cancel-incident {
            padding: 10px 20px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        #cancel-hazard:hover, #cancel-incident:hover {
            background: #b71c1c;
        }
        .hazard-info {
            display: none;
            position: absolute;
            background: #ffffff;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }
        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #ff0000;
            border-radius: 50%;
            margin-right: 5px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        /* Animation Definitions */
        @keyframes fadeInZoom {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC6pWyasaBezX1PMIsc14ClB1R2qDdcOjY&callback=initMap"></script>
    <script src="https://vjs.zencdn.net/8.5.2/video.js"></script>
    <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet">
</head>
<body>
    <div id="map-container">
        <form id="search-form" method="POST" action="/api/search">
            <input type="text" id="search-bar" name="searchText" placeholder="Search locations or routes">
            <button type="submit" id="search-button">üîç</button>
        </form>
        <div id="other-functions">Other Functions</div>
        <div id="view-live-feeds">View Live Feeds</div>
        <div id="function-menu">
            <button id="report-hazard">Report Hazard</button>
            <button id="report-incident">Report Incident</button>
        </div>
        <div id="map"></div>
        <div id="map-loading">Loading map...</div>
        <div id="map-error">Map failed to load. Check console for details.</div>
        <button id="toggle-options">Toggle Options</button>
    </div>
    <div id="options-panel">
        <button class="close-btn" onclick="this.parentElement.style.display='none'">√ó</button>
        <div id="controls">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div id="weather-icon"></div>
                <select name="city" id="city">
                    <option value="">Select City</option>
                    <option value="ho-chi-minh-city">Ho Chi Minh City</option>
                    <option value="da-nang">Da Nang</option>
                    <option value="can-tho">Can Tho</option>
                </select>
            </div>
            <select name="district" id="district">
                <option value="">Select District</option>
                <option value="district-1">District 1</option>
                <option value="district-3">District 3</option>
                <option value="binh-thanh">Binh Thanh</option>
            </select>
            <select name="road" id="road">
                <option value="">Select Road</option>
                <option value="le-loi">Le Loi</option>
                <option value="tran-hung-dao">Tran Hung Dao</option>
                <option value="nguyen-hue">Nguyen Hue</option>
            </select>
        </div>
        <div id="graph-container">
            <div id="graph-placeholder">Traffic Data Visualization</div>
        </div>
    </div>
    <div id="traffic-panel">
        <button class="close-btn" onclick="this.parentElement.style.display='none'">√ó</button>
        <div id="live-camera">
            <div id="camera-status">
                <span class="live-indicator"></span>LIVE
            </div>
            <select id="camera-select" name="camera">
                <option value="ly-thai-to-nguyen-dinh-chieu">L√Ω Th√°i T·ªï - Nguy·ªÖn ƒê√¨nh Chi·ªÉu</option>
                <option value="ba-thang-hai-su-van-hanh">3/2 - S∆∞ V·∫°n H·∫°nh</option>
                <option value="nga-sau-cong-hoa">N√∫t giao Ng√£ s√°u C·ªông H√≤a</option>
                <option value="ly-thai-to-su-van-hanh">L√Ω Th√°i T·ªï - S∆∞ V·∫°n H·∫°nh</option>
            </select>
            <video
                id="camera-video"
                class="video-js vjs-default-skin"
                controls
                preload="auto"
                data-setup="{}">
                <p class="vjs-no-js">
                    Loading live camera feed...
                </p>
            </video>
            <div id="camera-data"></div>
        </div>
    </div>
    <div id="hazard-form">
        <label for="hazard-cause">Hazard Cause:</label>
        <input type="text" id="hazard-cause" name="hazard-cause" placeholder="Enter hazard cause">
        <label for="hazard-severity">Severity (1-5):</label>
        <input type="number" id="hazard-severity" name="hazard-severity" min="1" max="5" placeholder="1-5">
        <label for="hazard-notes">Additional Notes:</label>
        <input type="text" id="hazard-notes" name="hazard-notes" placeholder="Enter notes">
        <label for="hazard-image">Upload Image:</label>
        <input type="file" id="hazard-image" name="hazard-image" accept="image/*">
        <button id="submit-hazard">Submit</button>
        <button id="cancel-hazard">Cancel</button>
    </div>
    <div id="incident-form">
        <label for="incident-description">Incident Description:</label>
        <input type="text" id="incident-description" name="incident-description" placeholder="Enter incident details">
        <label for="incident-type">Type:</label>
        <input type="text" id="incident-type" name="incident-type" placeholder="e.g., Accident, Roadblock">
        <label for="incident-impact">Impact Level (1-5):</label>
        <input type="number" id="incident-impact" name="incident-impact" min="1" max="5" placeholder="1-5">
        <label for="incident-image">Upload Image:</label>
        <input type="file" id="incident-image" name="incident-image" accept="image/*">
        <button id="submit-incident">Submit</button>
        <button id="cancel-incident">Cancel</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/express@5.1.0/dist/express.min.js"></script>
    <script>
        let map;
        let hazards = [];
        let incidents = [];
        let functionMenuVisible = false;
        let selectedLocation = null;
        let videoPlayer = null;

        // Camera data with actual locations and live image URLs
        const cameras = {
            'ly-thai-to-nguyen-dinh-chieu': {
                lat: 10.7831,
                lng: 106.6954,
                name: 'L√Ω Th√°i T·ªï - Nguy·ªÖn ƒê√¨nh Chi·ªÉu',
                cameraUrl: 'https://giaothong.hochiminhcity.gov.vn/expandcameraplayer/?camId=63ae763bbfd3d90017e8f0c4&camLocation=L%C3%BD%20Th%C3%A1i%20T%E1%BB%95%20-%20Nguy%E1%BB%85n%20%C4%90%C3%ACnh%20Chi%E1%BB%83u&camMode=camera&videoUrl=https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8',
                camId: '63ae763bbfd3d90017e8f0c4',
                imageUrl: '/api/cameras/63ae763bbfd3d90017e8f0c4/image',
                data: { density: '45%', weather: 'Sunny', traffic: 'Moderate' }
            },
            'ba-thang-hai-su-van-hanh': {
                lat: 10.7892,
                lng: 106.6638,
                name: '3/2 - S∆∞ V·∫°n H·∫°nh',
                cameraUrl: 'https://giaothong.hochiminhcity.gov.vn/expandcameraplayer/?camId=63ae7a50bfd3d90017e8f2b2&camLocation=Ba%20Th%C3%A1ng%20Hai%20%E2%80%93%20S%C6%B0%20V%E1%BA%A1n%20H%E1%BA%A1nh&camMode=camera&videoUrl=https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8',
                camId: '63ae7a50bfd3d90017e8f2b2',
                imageUrl: '/api/cameras/63ae7a50bfd3d90017e8f2b2/image',
                data: { density: '60%', weather: 'Cloudy', traffic: 'Heavy' }
            },
            'nga-sau-cong-hoa': {
                lat: 10.8010,
                lng: 106.6527,
                name: 'N√∫t giao Ng√£ s√°u C·ªông H√≤a',
                cameraUrl: 'https://giaothong.hochiminhcity.gov.vn/expandcameraplayer/?camId=5deb576d1dc17d7c5515acf6&camLocation=N%C3%BAt%20giao%20Ng%C3%A3%20s%C3%A1u%20C%E1%BB%99ng%20H%C3%B2a&camMode=camera&videoUrl=https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8',
                camId: '5deb576d1dc17d7c5515acf6',
                imageUrl: '/api/cameras/5deb576d1dc17d7c5515acf6/image',
                data: { density: '70%', weather: 'Rainy', traffic: 'Congested' }
            },
            'ly-thai-to-su-van-hanh': {
                lat: 10.7825,
                lng: 106.6823,
                name: 'L√Ω Th√°i T·ªï - S∆∞ V·∫°n H·∫°nh',
                cameraUrl: 'https://giaothong.hochiminhcity.gov.vn/expandcameraplayer/?camId=6623e7076f998a001b2523ea&camLocation=L%C3%BD%20Th%C3%A1i%20T%E1%BB%95%20-%20S%C6%B0%20V%E1%BA%A1n%20H%E1%BA%A1nh&camMode=camera&videoUrl=https://d2zihajmogu5jn.cloudfront.net/bipbop-advanced/bipbop_16x9_variant.m3u8',
                camId: '6623e7076f998a001b2523ea',
                imageUrl: '/api/cameras/6623e7076f998a001b2523ea/image',
                data: { density: '35%', weather: 'Sunny', traffic: 'Free Flow' }
            }
        };

        let currentCameraId = null;
        let refreshInterval = null;

        function initMap() {
            document.getElementById('map-loading').style.display = 'none';
            try {
                const hoChiMinhCity = { lat: 10.7769, lng: 106.7009 };
                map = new google.maps.Map(document.getElementById("map"), {
                    center: hoChiMinhCity,
                    zoom: 12,
                });
                console.log("Map initialized successfully. Buttons should be visible.");
                document.getElementById('map-error').style.display = 'none';
                loadHazards();
                loadIncidents();
                addCameraMarkers();
                initializeVideoPlayer();
            } catch (error) {
                console.error("Error initializing map:", error);
                document.getElementById('map-error').style.display = 'block';
            }
        }

        function initializeVideoPlayer() {
            // Load default camera
            loadCameraFeed('ly-thai-to-nguyen-dinh-chieu');
        }

        function loadCameraFeed(cameraId) {
            const camera = cameras[cameraId];
            if (camera) {
                currentCameraId = cameraId;
                
                // Clear existing refresh interval
                if (refreshInterval) {
                    clearInterval(refreshInterval);
                }
                
                // Replace video player with live image container
                const videoContainer = document.getElementById('camera-video');
                videoContainer.innerHTML = `
                    <div style="width: 100%; height: 100%; position: relative; background: #000; display: flex; align-items: center; justify-content: center;">
                        <img id="live-camera-image" 
                             src="" 
                             alt="Live Camera Feed" 
                             style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px;"
                             onload="updateImageTimestamp()"
                             onerror="handleImageError()">
                        <div id="image-loading" 
                             style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; display: none;">
                             Loading...
                        </div>
                        <div id="last-update" 
                             style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px; border-radius: 3px; font-size: 12px;">
                             Connecting...
                        </div>
                    </div>
                `;
                
                // Load initial image
                loadCameraImage();
                
                // Set up auto-refresh every 15 seconds (similar to the official app)
                refreshInterval = setInterval(() => {
                    loadCameraImage();
                }, 15000);
                
                // Update camera data display
                const cameraData = document.getElementById('camera-data');
                cameraData.innerHTML = `
                    Location: ${camera.name}<br>
                    Traffic Density: ${camera.data.density}<br>
                    Weather: ${camera.data.weather}<br>
                    Status: ${camera.data.traffic}<br>
                    <small>Auto-refresh: 15s</small>
                `;
                cameraData.style.display = 'block';

                // Center map on selected camera
                if (map) {
                    map.setCenter({ lat: camera.lat, lng: camera.lng });
                    map.setZoom(16);
                }
            }
        }

        async function loadCameraImage() {
            if (!currentCameraId) return;
            
            const camera = cameras[currentCameraId];
            if (!camera) return;
            
            const imageElement = document.getElementById('live-camera-image');
            const loadingElement = document.getElementById('image-loading');
            
            if (imageElement && loadingElement) {
                loadingElement.style.display = 'block';
                
                try {
                    // Add timestamp to prevent caching
                    const timestamp = Date.now();
                    const response = await fetch(`/api/cameras/${camera.camId}/image?t=${timestamp}`);
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const imageUrl = URL.createObjectURL(blob);
                        imageElement.src = imageUrl;
                    } else {
                        // Fallback: show iframe with original camera page
                        const videoContainer = document.getElementById('camera-video');
                        videoContainer.innerHTML = `
                            <iframe 
                                src="${camera.cameraUrl}" 
                                width="100%" 
                                height="100%" 
                                frameborder="0" 
                                allowfullscreen
                                style="border-radius: 4px;">
                            </iframe>
                        `;
                    }
                } catch (error) {
                    console.error('Error loading camera image:', error);
                    handleImageError();
                } finally {
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                }
            }
        }

        function updateImageTimestamp() {
            const timestampElement = document.getElementById('last-update');
            if (timestampElement) {
                const now = new Date();
                timestampElement.textContent = `Last update: ${now.toLocaleTimeString()}`;
            }
        }

        function handleImageError() {
            const camera = cameras[currentCameraId];
            if (camera) {
                // Fallback to iframe when image fails
                const videoContainer = document.getElementById('camera-video');
                videoContainer.innerHTML = `
                    <iframe 
                        src="${camera.cameraUrl}" 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        allowfullscreen
                        style="border-radius: 4px;">
                    </iframe>
                `;
            }
        }

        window.initMap = initMap;

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, initializing map...");
            document.getElementById('map-loading').style.display = 'block';
            if (window.google && window.google.maps) {
                initMap();
            } else {
                console.error("Google Maps API not loaded yet.");
            }
        });

        window.addEventListener('load', function() {
            console.log("Window loaded, verifying elements...");
            if (typeof google === 'undefined' || typeof google.maps === 'undefined') {
                console.error("Google Maps API failed to load");
                document.getElementById('map-loading').style.display = 'none';
                document.getElementById('map-error').style.display = 'block';
            } else if (!document.getElementById('map').innerHTML) {
                initMap();
            }

            // Add drag functionality for panels
            const panels = ['options-panel', 'traffic-panel'];
            panels.forEach(panelId => {
                const panel = document.getElementById(panelId);
                let isDragging = false;
                let currentX = 0;
                let currentY = 0;
                let initialX;
                let initialY;

                panel.addEventListener('mousedown', startDragging);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDragging);

                function startDragging(e) {
                    initialX = e.clientX - currentX;
                    initialY = e.clientY - currentY;
                    isDragging = true;
                }

                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;
                        panel.style.left = currentX + 'px';
                        panel.style.top = currentY + 'px';
                    }
                }

                function stopDragging() {
                    isDragging = false;
                }

                // Initialize position
                panel.style.position = 'absolute';
                currentX = panel.offsetLeft;
                currentY = panel.offsetTop;
            });
        });

        // Camera selection change handler
        document.getElementById('camera-select').addEventListener('change', function() {
            const selectedCamera = this.value;
            loadCameraFeed(selectedCamera);
        });

        document.getElementById('search-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const searchText = document.getElementById('search-bar').value;
            if (searchText) {
                const response = await fetch(`/api/search?query=${encodeURIComponent(searchText)}`, {
                    method: 'GET'
                });
                const result = await response.json();
                if (result.success) {
                    alert(`Search results for: ${searchText}`);
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: searchText }, (results, status) => {
                        if (status === 'OK' && results[0]) {
                            map.setCenter(results[0].geometry.location);
                            map.setZoom(14);
                            new google.maps.Marker({
                                map: map,
                                position: results[0].geometry.location
                            });
                        } else {
                            alert('Location not found');
                        }
                    });
                } else {
                    alert(result.message);
                }
            }
        });

        document.getElementById('toggle-options').addEventListener('click', function() {
            const panel = document.getElementById('options-panel');
            panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
        });

        document.getElementById('view-live-feeds').addEventListener('click', function() {
            const panel = document.getElementById('traffic-panel');
            panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
        });

        const otherFunctions = document.getElementById('other-functions');
        const functionMenu = document.getElementById('function-menu');

        otherFunctions.addEventListener('click', function(e) {
            e.stopPropagation();
            functionMenuVisible = !functionMenuVisible;
            functionMenu.style.display = functionMenuVisible ? 'block' : 'none';
        });

        document.addEventListener('click', function(e) {
            if (!otherFunctions.contains(e.target) && !functionMenu.contains(e.target)) {
                functionMenu.style.display = 'none';
                functionMenuVisible = false;
            }
        });

        document.getElementById('report-hazard').addEventListener('click', function() {
            functionMenu.style.display = 'none';
            functionMenuVisible = false;
            map.setOptions({ draggableCursor: 'url(https://maps.google.com/mapfiles/kml/paddle/red-circle.png), auto' });
            map.addListener('click', async function(event) {
                selectedLocation = event.latLng;
                map.setOptions({ draggableCursor: null });
                const form = document.getElementById('hazard-form');
                form.style.display = 'block';
                document.getElementById('submit-hazard').focus();
                google.maps.event.clearListeners(map, 'click');
            });
        });

        document.getElementById('report-incident').addEventListener('click', function() {
            functionMenu.style.display = 'none';
            functionMenuVisible = false;
            map.setOptions({ draggableCursor: 'url(https://maps.google.com/mapfiles/kml/paddle/red-circle.png), auto' });
            map.addListener('click', async function(event) {
                selectedLocation = event.latLng;
                map.setOptions({ draggableCursor: null });
                const form = document.getElementById('incident-form');
                form.style.display = 'block';
                document.getElementById('submit-incident').focus();
                google.maps.event.clearListeners(map, 'click');
            });
        });

        document.getElementById('submit-hazard').addEventListener('click', async function() {
            const cause = document.getElementById('hazard-cause').value;
            const severity = document.getElementById('hazard-severity').value;
            const notes = document.getElementById('hazard-notes').value;
            const imageInput = document.getElementById('hazard-image');
            const imageFile = imageInput.files[0];
            console.log('Submitting hazard:', { cause, severity, notes, imageFile, lat: selectedLocation?.lat(), lng: selectedLocation?.lng() });
            if (cause && selectedLocation && severity && notes) {
                const formData = new FormData();
                formData.append('lat', selectedLocation.lat());
                formData.append('lng', selectedLocation.lng());
                formData.append('cause', cause);
                formData.append('severity', parseInt(severity));
                formData.append('notes', notes);
                formData.append('timestamp', new Date().toISOString());
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                try {
                    const response = await fetch('/api/hazards', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    console.log('Server response:', result);
                    if (result.success) {
                        addHazardMarker(result.hazard);
                        document.getElementById('hazard-form').style.display = 'none';
                        document.getElementById('hazard-cause').value = '';
                        document.getElementById('hazard-severity').value = '';
                        document.getElementById('hazard-notes').value = '';
                        imageInput.value = '';
                        selectedLocation = null;
                    } else {
                        alert(`Error: ${result.message}`);
                    }
                } catch (error) {
                    console.error('Fetch error:', error);
                    alert('An error occurred while submitting the hazard.');
                }
            } else {
                alert('Please fill all required fields and select a location.');
            }
        });

        document.getElementById('submit-incident').addEventListener('click', async function() {
            const description = document.getElementById('incident-description').value;
            const type = document.getElementById('incident-type').value;
            const impact = document.getElementById('incident-impact').value;
            const imageInput = document.getElementById('incident-image');
            const imageFile = imageInput.files[0];
            if (description && selectedLocation && type && impact) {
                const formData = new FormData();
                formData.append('lat', selectedLocation.lat());
                formData.append('lng', selectedLocation.lng());
                formData.append('description', description);
                formData.append('type', type);
                formData.append('impact', parseInt(impact));
                formData.append('timestamp', new Date().toISOString());
                formData.append('verified', false);
                if (imageFile) {
                    formData.append('image', imageFile);
                }

                const response = await fetch('/api/incidents', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    addIncidentMarker(result.incident);
                    document.getElementById('incident-form').style.display = 'none';
                    document.getElementById('incident-description').value = '';
                    document.getElementById('incident-type').value = '';
                    document.getElementById('incident-impact').value = '';
                    imageInput.value = '';
                    selectedLocation = null;
                }
            }
        });

        document.getElementById('cancel-hazard').addEventListener('click', function() {
            document.getElementById('hazard-form').style.display = 'none';
            document.getElementById('hazard-cause').value = '';
            document.getElementById('hazard-severity').value = '';
            document.getElementById('hazard-notes').value = '';
            document.getElementById('hazard-image').value = '';
            selectedLocation = null;
            map.setOptions({ draggableCursor: null });
            google.maps.event.clearListeners(map, 'click');
        });

        document.getElementById('cancel-incident').addEventListener('click', function() {
            document.getElementById('incident-form').style.display = 'none';
            document.getElementById('incident-description').value = '';
            document.getElementById('incident-type').value = '';
            document.getElementById('incident-impact').value = '';
            document.getElementById('incident-image').value = '';
            selectedLocation = null;
            map.setOptions({ draggableCursor: null });
            google.maps.event.clearListeners(map, 'click');
        });

        async function loadHazards() {
            const response = await fetch('/api/hazards');
            const data = await response.json();
            if (data.success) {
                hazards = data.hazards;
                hazards.forEach(addHazardMarker);
            }
        }

        async function loadIncidents() {
            const response = await fetch('/api/incidents');
            const data = await response.json();
            if (data.success) {
                incidents = data.incidents;
                incidents.forEach(addIncidentMarker);
            }
        }

        function addHazardMarker(hazard) {
            const marker = new google.maps.Marker({
                position: { lat: hazard.lat, lng: hazard.lng },
                map: map,
                icon: {
                    url: 'https://maps.google.com/mapfiles/kml/shapes/caution.png',
                    scaledSize: new google.maps.Size(32, 32)
                }
            });
            const infoWindow = new google.maps.InfoWindow({
                content: `<div>Hazard: ${hazard.cause}<br>Severity: ${hazard.severity}<br>Notes: ${hazard.notes}<br>Time: ${hazard.timestamp}<br>Lat: ${hazard.lat}, Lng: ${hazard.lng}<br>${hazard.imageUrl ? `Image: <img src="${hazard.imageUrl}" width="100">` : ''}</div>`
            });
            marker.addListener('mouseover', function() {
                infoWindow.open(map, marker);
            });
            marker.addListener('mouseout', function() {
                infoWindow.close();
            });
        }

        function addIncidentMarker(incident) {
            const marker = new google.maps.Marker({
                position: { lat: incident.lat, lng: incident.lng },
                map: map,
                icon: {
                    url: 'https://maps.google.com/mapfiles/kml/shapes/placemark_circle.png',
                    scaledSize: new google.maps.Size(32, 32)
                }
            });
            const infoWindow = new google.maps.InfoWindow({
                content: `<div>Incident: ${incident.description}<br>Type: ${incident.type}<br>Impact: ${incident.impact}<br>Time: ${incident.timestamp}<br>Verified: ${incident.verified ? 'Yes' : 'No'}<br>Lat: ${incident.lat}, Lng: ${incident.lng}<br>${incident.imageUrl ? `Image: <img src="${incident.imageUrl}" width="100">` : ''}</div>`
            });
            marker.addListener('mouseover', function() {
                infoWindow.open(map, marker);
            });
            marker.addListener('mouseout', function() {
                infoWindow.close();
            });
        }

        function addCameraMarkers() {
            Object.entries(cameras).forEach(([id, camera]) => {
                const marker = new google.maps.Marker({
                    position: { lat: camera.lat, lng: camera.lng },
                    map: map,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/kml/shapes/camera.png',
                        scaledSize: new google.maps.Size(32, 32)
                    }
                });
                
                const infoWindow = new google.maps.InfoWindow({
                    content: `
                        <div style="min-width: 200px;">
                            <h4>${camera.name}</h4>
                            <p><strong>Traffic:</strong> ${camera.data.traffic}</p>
                            <p><strong>Density:</strong> ${camera.data.density}</p>
                            <p><strong>Weather:</strong> ${camera.data.weather}</p>
                            <button onclick="selectCameraFromMap('${id}')" style="background: #2e7d32; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                View Live Feed
                            </button>
                        </div>
                    `
                });
                
                marker.addListener('click', () => {
                    infoWindow.open(map, marker);
                });
            });
        }

        // Global function to select camera from map
        window.selectCameraFromMap = function(cameraId) {
            // Open the traffic panel if not already open
            const panel = document.getElementById('traffic-panel');
            panel.style.display = 'block';
            
            // Select the camera in the dropdown
            document.getElementById('camera-select').value = cameraId;
            
            // Load the camera feed
            loadCameraFeed(cameraId);
        };

        // Load data on startup
        loadHazards();
        loadIncidents();
    </script>
</body>
</html>